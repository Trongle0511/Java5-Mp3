<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scooped- Playlist</title>
    <!-- it is connected to two stylesheets -->
    <link rel="stylesheet" type="text/css" href="Single Playlist Screen Styles.css"><!-- this is the main stylesheet -->
<!--    <link rel="stylesheet" type="text/css" href="Stylesheet_main.css">&lt;!&ndash; this is the main stylesheet &ndash;&gt;-->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">

    <!-- desktop first approach is used for the same. -->
    <link rel="stylesheet" type="text/css" href="Secondary page responsive.css">
    <!-- this is the style sheet with all the media queries -->
    <!-- this script is just for font awesome fonts -->
    <script src="https://kit.fontawesome.com/2d9b67a497.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    button#sort-asc,
    button#sort-desc {
        /* CSS của cả hai nút */
        padding: 10px;
        margin: 5px;
        border: none;
        background-color: #007BFF;
        color: white;
        cursor: pointer;
    }

    button#sort-asc:hover,
    button#sort-desc:hover {
        /* CSS hover của cả hai nút */
        background-color: #0056b3;
    }
</style>
</head>
<!-- body -->

<body>
<!-- top navigation bar -->
<nav class="navigation-bar">
    <!-- this div contains the logo and title os the page -->
    <div class="title-combo">
        <div class="website-logo">
            <a href="/MusicMp3">
                <img src="media/website_logo.svg"></a>
        </div>
        <div class="website-name">
            <h1>
                <a href="/MusicMp3">
                    Scooped
                </a>
            </h1>
            <h4 style="color: magenta;">
                <a href="index.html">Online Music Player</a>
            </h4>
        </div>
    </div>
    <!-- this is the animated favourites text -->
    <div class="favs">
        <h4>
            Favourites
        </h4>
    </div>
</nav>
<!-- this is the main center part of the page and it is divided into two sections, namely section 1 and section 2-->
<!-- I have separated these sections using the aside tag for each section -->
<main>
    <!-- aside section 1 -->
    <aside class="aside section-1">
        <!-- now the playlist part begins -->
        <div class="playlist-items" id="songs-container">
            <!-- playlist item -->

        </div>
    </aside>
    <!-- one aside section is complete -->
    <!-- now the second aside section will start from here -->
    <!-- the page is responsive. please try reducing the width of the page -->
    <!-- the aside section will collapse and a "more button will be shown to you." -->
    <!-- clicking on this more button, you will be shown the aside section 2  -->
    <!-- its position will be absolute at lower resolutions -->
    <!-- this is the label for that more button -->
    <label for="more"><i class="fas fa-angle-double-left"></i>More</label>
    <!-- this is that more button -->
    <!-- and this is the check box. this will always be hidden -->
    <!-- check the stylesheet_main.css when the label is clicked, this checkbox will be checked -->
    <!-- which will invoke the aside section 2 on lower resolutions -->
    <input type="checkbox" id="more">
    <!-- </div> -->
</main>

<footer>
    <div class="active-song-description">
        <div id="song-image">
            <img src="media/latest english/roar.jpg" alt="Current song image">
        </div>
        <div class="song-desc">
            <div>Imagine by John</div>
            <div>John Lennon</div>
        </div>
    </div>
    <div class="player">
        <div class="controls">
            <div id="random-button"><i class="fas fa-random"></i></div>
            <div id="prev-button"><i class="fas fa-step-backward"></i></div>
            <div id="play-pause-button"><i class="fas fa-play-circle"></i></div>
            <div id="next-button"><i class="fas fa-step-forward"></i></div>
            <div id="reset-button"><i class="fas fa-redo"></i></div>
        </div>
        <div id="slider">
            <div class="time">
                <span id="current-time">0:00</span>
            </div>
            <div id="time-slider" class="slidecontainer">
                <input type="range" min="0" max="100" value="0" class="slider" id="songTime">
            </div>
            <div class="time">
                <span id="total-time">0:00</span>
            </div>
        </div>
    </div>


    <div class="extras">
        <!--        <div><i class="fas fa-list-ul"></i></div>-->
        <!--        <div><i class="fas fa-laptop"></i></div>-->
        <div id="volume-icon"><i class="fas fa-volume-up" style="padding-right: 10px" ></i></div>
        <div class="slidecontainer" style="width:30%;">
            <input type="range" min="0" max="100" value="100" class="slider" id="volumeRange" style="margin-top:0; padding-bottom: 4px;">
        </div>
    </div>
</footer>
<audio id="audio-player" controls style="display:none;"></audio>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        const songsContainer = document.getElementById('songs-container');
        const audioPlayer = document.getElementById('audio-player');
        const footerSongImage = document.getElementById('song-image').querySelector('img');
        const footerSongName = document.querySelector('.song-desc div:nth-child(1)');
        const footerSongAuthor = document.querySelector('.song-desc div:nth-child(2)');
        const playPauseButton = document.getElementById('play-pause-button').querySelector('i');
        const currentTimeElement = document.getElementById('current-time');
        const totalTimeElement = document.getElementById('total-time');
        const timeSlider = document.getElementById('songTime');
        const volumeRange = document.getElementById('volumeRange');
        const nextButton = document.getElementById('next-button');
        const prevButton = document.getElementById('prev-button');
        const resetButton = document.getElementById('reset-button');
        const volumeIcon = document.getElementById('volume-icon');
        const randomButton = document.getElementById('random-button');

        let currentSong = null;


        // Function to format time in mm:ss
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secondsRemaining = Math.floor(seconds % 60);
            return `${minutes}:${secondsRemaining < 10 ? '0' : ''}${secondsRemaining}`;
        }

        function getSongsFavorites() {
            return axios.get('/favorites');
        }

        // Function to get song details by ID
        function getSongDetails(songId) {
            return axios.get(`/api-public/song/findSongId?songId=${songId}`);
        }

        // Function to render songs
        getSongsFavorites()
            .then(response => {
                const songs = response.data;
                console.log(songs)
                songs.forEach((song, index) => {
                    const songDiv = document.createElement('div');
                    songDiv.className = 'playlist-item';
                    songDiv.innerHTML = `
                                        <div class="left">
                                            <div>${String(index + 1).padStart(2, '0')}</div>
                                            <div>
                                                <img src="/library/image/${song.image}" alt="${song.song_name}">
                                                <div class="play-btn" data-song-id="${song.songID}" data-song-src="/library/Music/${song.audio_file}"
                         data-song-image="/library/image/${song.image}" data-song-name="${song.song_name}" data-song-author="${song.artist.artists_name}">
                                                    <i class="fas fa-play"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <h5>${song.song_name}</h5>
                                                 <!-- Đổi thành tên của nghệ sĩ từ phản hồi API -->
                                            </div>
                                        </div>
                                        <div class="center">
                                            4:44
                                        </div>
                                        <div class="right">
                                            <div>
                                                <button class="remove-favorites" data-user-id="1" data-song-id="${song.songID}">
                                                    <i class="fas fa-minus-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `;
                    songsContainer.appendChild(songDiv);
                });

                const playButtons = document.querySelectorAll('.play-btn');
                playButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const songId = this.getAttribute('data-song-id');
                        const songSrc = this.getAttribute('data-song-src');
                        const songImage = this.getAttribute('data-song-image');
                        const songName = this.getAttribute('data-song-name');
                        const songAuthor = this.getAttribute('data-song-author');
                        playPauseButton.innerHTML = '<i class="fas fa-pause-circle"></i>';

                        // Call getSongDetails with the selected song ID
                        getSongDetails(songId)
                            .then(function (response) {
                                if (response.status === 200) {
                                    const songDetails = response.data;
                                    console.log('Song Details:', songDetails);

                                    // Update footer with song details
                                    footerSongImage.src = songImage;
                                    footerSongName.textContent = songName;
                                    footerSongAuthor.textContent = songAuthor;

                                    // Update the audio source and play the song
                                    audioPlayer.src = songSrc;
                                    audioPlayer.play();
                                    let isThirtySecondsReached = false;
                                    audioPlayer.addEventListener('timeupdate', function() {
                                        console.log("Thời gian hiện tại:", audioPlayer.currentTime);
                                        if (!isThirtySecondsReached && audioPlayer.currentTime >= 29) {
                                            isThirtySecondsReached = true;
                                            updateListenCount(songId);
                                        }
                                    });

                                    // Set the volume to maximum
                                    audioPlayer.volume = 1;
                                    volumeRange.value = 100;

                                    // Update the play/pause button
                                    playPauseButton.classList.remove('fa-play-circle');
                                    playPauseButton.classList.add('fa-pause-circle');

                                    // Set the current song
                                    currentSong = {
                                        songId,
                                        songSrc,
                                        songImage,
                                        songName,
                                        songAuthor
                                    };
                                } else {
                                    alert('Failed to get song details');
                                }
                            })
                            .catch(function (error) {
                                console.error('Error fetching song details:', error);
                            });
                    });
                });

                const removeButtons = document.querySelectorAll('.remove-favorites');

                removeButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const userId = this.getAttribute('data-user-id');
                        const songId = this.getAttribute('data-song-id');

                        Swal.fire({
                            title: "Bạn chắc chắn?",
                            text: "Xóa bài hát ra khỏi mục yêu thích!",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#3085d6",
                            cancelButtonColor: "#d33",
                            confirmButtonText: "Yes, delete it!"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                axios.delete('/delete-favorites', {
                                    params: { userId, songId }
                                })
                                    .then(response => {
                                        Swal.fire({
                                            title: "Đã Xóa!",
                                            text: "Bạn đã xóa bài hát khỏi mục yêu thích.",
                                            icon: "success"
                                        }).then(() => {
                                            // Remove the song from the DOM
                                            button.closest('.playlist-item').remove();
                                            // Reload the page
                                            location.reload();
                                        });
                                    })
                                    .catch(error => {
                                        let errorMessage = "Lỗi hệ thống. Vui lòng thử lại sau.";
                                        if (error.response && error.response.data) {
                                            errorMessage = error.response.data;
                                        }
                                        Swal.fire({
                                            title: "Error!",
                                            text: errorMessage,
                                            icon: "error"
                                        });
                                    });
                            }
                        });
                    });
                });



            })

            .catch(error => {
                console.error('Error fetching songs:', error);
            });




        // Play/pause button functionality
        playPauseButton.addEventListener('click', function () {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseButton.classList.remove('fa-play-circle');
                playPauseButton.classList.add('fa-pause-circle');
            } else {
                audioPlayer.pause();
                playPauseButton.classList.remove('fa-pause-circle');
                playPauseButton.classList.add('fa-play-circle');
            }
        });

        // Update the play/pause button when the song ends
        audioPlayer.addEventListener('ended', function () {
            playPauseButton.classList.remove('fa-pause-circle');
            playPauseButton.classList.add('fa-play-circle');
        });

        // Update current time and total time
        audioPlayer.addEventListener('timeupdate', function () {
            currentTimeElement.textContent = formatTime(audioPlayer.currentTime);
            timeSlider.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        });

        // Set total time when metadata is loaded
        audioPlayer.addEventListener('loadedmetadata', function () {
            totalTimeElement.textContent = formatTime(audioPlayer.duration);
        });

        // Seek functionality
        timeSlider.addEventListener('input', function () {
            const seekTime = (timeSlider.value / 100) * audioPlayer.duration;
            audioPlayer.currentTime = seekTime;
        });

        // Volume control functionality
        volumeRange.addEventListener('input', function () {
            audioPlayer.volume = volumeRange.value / 100;
        });

        // Set initial volume to max
        audioPlayer.volume = 1;
        volumeRange.value = 100;


        // xử lí nút next
        nextButton.addEventListener('click', function () {
            if (isRandomActive) { // Kiểm tra xem nút Random có được kích hoạt không
                const playButtons = document.querySelectorAll('.play-btn');
                const randomIndex = Math.floor(Math.random() * playButtons.length); // Chọn một số ngẫu nhiên từ 0 đến độ dài danh sách bài hát
                const randomButton = playButtons[randomIndex]; // Lấy phần tử ở vị trí ngẫu nhiên trong danh sách bài hát
                loadAndPlaySong(randomButton); // Tải và phát bài hát từ phần tử đã chọn ngẫu nhiên
            } else { // Nếu nút Random không được kích hoạt, thực hiện chức năng Next bình thường
                const currentButton = document.querySelector('.current-song');
                const playButtons = document.querySelectorAll('.play-btn' +
                    '');
                const currentIndex = Array.from(playButtons).indexOf(currentButton);
                let nextIndex;

                if (currentIndex === playButtons.length - 1) {
                    nextIndex = 0; // Quay lại bài hát đầu nếu đang ở cuối danh sách
                } else {
                    nextIndex = currentIndex + 1;
                }

                const nextButton = playButtons[nextIndex];
                loadAndPlaySong(nextButton);
            }
        });


        // xử lí nút prev
        prevButton.addEventListener('click', function () {
            if (isRandomActive) { // Kiểm tra xem nút Random có được kích hoạt không
                const playButtons = document.querySelectorAll('.play-btn');
                const randomIndex = Math.floor(Math.random() * playButtons.length); // Chọn một số ngẫu nhiên từ 0 đến độ dài danh sách bài hát
                const randomButton = playButtons[randomIndex]; // Lấy phần tử ở vị trí ngẫu nhiên trong danh sách bài hát
                loadAndPlaySong(randomButton); // Tải và phát bài hát từ phần tử đã chọn ngẫu nhiên
            } else { // Nếu nút Random không được kích hoạt, thực hiện chức năng Prev bình thường
                const currentButton = document.querySelector('.current-song');
                const playButtons = document.querySelectorAll('.play-btn');
                const currentIndex = Array.from(playButtons).indexOf(currentButton);
                let prevIndex;

                if (currentIndex === 0) {
                    prevIndex = playButtons.length - 1; // Quay lại bài hát cuối nếu đang ở đầu danh sách
                } else {
                    prevIndex = currentIndex - 1;
                }

                const prevButton = playButtons[prevIndex];
                loadAndPlaySong(prevButton);
            }
        });


        // xử lí nút reset
        resetButton.addEventListener('click', function () {
            audioPlayer.currentTime = 0;
        });


        // Hàm load và phát bài hát
        function loadAndPlaySong(button) {
            const songId = button.getAttribute('data-song-id');
            const songSrc = button.getAttribute('data-song-src');
            const songImage = button.getAttribute('data-song-image');
            const songName = button.getAttribute('data-song-name');
            const songAuthor = button.getAttribute('data-song-author');

            // Cập nhật footer với chi tiết bài hát
            footerSongImage.src = songImage;
            footerSongName.textContent = songName;
            footerSongAuthor.textContent = songAuthor;

            // Cập nhật nguồn audio và phát bài hát
            audioPlayer.src = songSrc;
            audioPlayer.play();

            // Đặt âm lượng về tối đa
            audioPlayer.volume = 1;
            volumeRange.value = 100;

            // Cập nhật nút play/pause
            playPauseButton.innerHTML = '<i class="fas fa-pause-circle"></i>';
            playPauseButton.classList.remove('fa-play-circle');
            playPauseButton.classList.add('fa-pause-circle');

            // Loại bỏ lớp 'current-song' từ nút hiện tại
            const currentButton = document.querySelector('.current-song');
            if (currentButton) {
                currentButton.classList.remove('current-song');
            }

            // Thêm lớp 'current-song' vào nút mới
            button.classList.add('current-song');
        }

        // Xử lý sự kiện cho nút Random
        let isRandomActive = false;

        randomButton.addEventListener('click', function () {
            isRandomActive = !isRandomActive; // Đảo ngược trạng thái của nút Random
            if (isRandomActive) {
                randomButton.style.color = 'green'; // Đổi màu nút Random thành xanh
            } else {
                randomButton.style.color = ''; // Đặt màu trở lại mặc định
            }
        });


        // xử lí cho nút tắt giảm âm lượng
        volumeIcon.addEventListener('click', function () {
            if (audioPlayer.volume > 0) {
                audioPlayer.volume = 0;
                volumeRange.value = 0;
            } else {
                audioPlayer.volume = 1;
                volumeRange.value = 100;
            }
        });

    });


    // Get audio element
    var audio = document.getElementById("audio-player");

    // Get play/pause button
    var playPauseButton = document.getElementById("play-pause-button");

    // Play/pause function
    function togglePlayPause() {
        if (audio.paused) {
            audio.play();
            playPauseButton.innerHTML = '<i class="fas fa-pause-circle"></i>';
        } else {
            audio.pause();
            playPauseButton.innerHTML = '<i class="fas fa-play-circle"></i>';
        }
    }

    // Add click event listener to play/pause button
    playPauseButton.addEventListener("click", togglePlayPause);

    // Update current time and total time
    audio.addEventListener("timeupdate", function () {
        var currentTime = document.getElementById("current-time");
        var totalTime = document.getElementById("total-time");
        currentTime.innerHTML = formatTime(audio.currentTime);
        totalTime.innerHTML = formatTime(audio.duration);
    });

    // Function to format time (mm:ss)
    function formatTime(time) {
        var minutes = Math.floor(time / 60);
        var seconds = Math.floor(time % 60);
        return minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
    }

    // Volume control
    var volumeRange = document.getElementById("volumeRange");
    volumeRange.addEventListener("change", function () {
        audio.volume = volumeRange.value / 100;
    });
    // Lấy phần tử thanh trượt thời gian
    var timeSlider = document.getElementById("songTime");

    // Khi bài hát được phát, cập nhật giá trị của thanh trượt thời gian
    audio.addEventListener("timeupdate", function () {
        var currentTime = audio.currentTime;
        var duration = audio.duration;
        var percentage = (currentTime / duration) * 100;
        timeSlider.value = percentage;
    });

    // Khi người dùng di chuyển thanh trượt, điều chỉnh thời gian của bài hát
    timeSlider.addEventListener("input", function () {
        var percentage = timeSlider.value;
        var duration = audio.duration;
        var currentTime = (percentage * duration) / 100;
        audio.currentTime = currentTime;
    });
    // Lấy phần tử thanh trượt thời gian
    var timeSlider = document.getElementById("songTime");

    // Khi bài hát được phát, cập nhật giá trị của thanh trượt thời gian và tạo biến --range-value
    audio.addEventListener("timeupdate", function () {
        var currentTime = audio.currentTime;
        var duration = audio.duration;
        var percentage = (currentTime / duration) * 100;
        timeSlider.value = percentage;
        timeSlider.style.setProperty('--range-value', percentage + '%');
    });







</script>


</body>

</html>